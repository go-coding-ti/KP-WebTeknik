<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8" />
    <title>Tugas 3</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <!-- Le styles -->
    <link data-require="bootstrap-css" data-semver="3.3.6" rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.css" />
    <link type="text/css" rel="stylesheet" href="//cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />

    <link href="style.css" rel="stylesheet" />
    <link href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" rel="stylesheet" />
    <link href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" rel="stylesheet" />
    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="images/favicon.ico" />
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png" />
    <!-- Le javascript
    ================================================== -->
    <script data-require="jquery" data-semver="2.1.4" src="https://code.jquery.com/jquery-2.1.4.js"></script>
    <script data-require="bootstrap" data-semver="3.3.6" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script type="application/javascript" src="//cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>

    //CLUSTER STYLE
    <style>
      .leaflet-div-icon{
        background: (255, 255, 255, 0.5);
        border: 1px solid rgba(255,17,17,0.692);
        border-radius: 20%;
        position: absolute;
        display: block;
        text-align: center;
        line-height: 30px;
    }

      .leaflet-div-icon-SD{
        background: rgba(255, 72, 26, 0.438);
        border: 1px solid rgba(255,17,17,0.692);
        border-radius: 100%;
        position: center;
        display: block;
        text-align: center;
        line-height: 30px;
    }

    .leaflet-div-icon-SMP{
        background: rgba(30, 255, 124, 0.438);
        border: 1px solid rgba(255,17,17,0.692);
        border-radius: 100%;
        position: center;
        display: block;
        text-align: center;
        line-height: 30px;
    }

    .leaflet-div-icon-SMA{
        background: rgba(34, 30, 255, 0.438);
        border: 1px solid rgba(255,17,17,0.692);
        border-radius: 100%;
        position: center;
        display: block;
        text-align: center;
        line-height: 30px;
    }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <!-- MODAL ADD-->
    <div id="mymodal" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">            
            <h4 class="modal-title">Tambah Sekolah</h4>
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          </div>
          <div class="modal-body">          
            <div class="form-group">
              <label>Nama Sekolah</label>
              <input type="text" class="form-control" id="nama" required>
            </div>
            <div class="form-group">
              <label>Jenis Sekolah</label>
              <select class="form-control" name="jenis" id="jenis" form="formpost">
                  <option value="SD">SD</option>
                  <option value="SMP">SMP</option>
                  <option value="SMA">SMA</option>
              </select>
            </div>
            <div class="form-group">
              <label>Latitude</label>
              <input type="text" class="form-control" id="latitude"  readonly>
            </div>
            <div class="form-group">
              <label>Longitude</label>
              <input type="text" class="form-control" id="longitude" readonly>
            </div>
          </div>
          <div class="modal-footer">
            <input type="button" class="btn btn-default" data-dismiss="modal" id="cancelBtn" value="Cancel">
            <input type="submit" class="btn btn-success" value="Add" id="addBtn">
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div id="editmodal" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">            
            <h4 class="modal-title">Edit Sekolah</h4>
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          </div>
          <div class="modal-body">          
            <div class="form-group">
              <label>Nama Sekolah</label>
              <input type="text" class="form-control" id="namaEdit" required>
            </div>
            <div class="form-group">
              <label>Jenis Sekolah</label>
              <select class="form-control" name="jenis" id="jenisEdit" form="formpost">
                  <option value="SD">SD</option>
                  <option value="SMP">SMP</option>
                  <option value="SMA">SMA</option>
              </select>
            </div>
            <div class="form-group">
              <label>Latitude</label>
              <input type="text" class="form-control" id="latitudeEdit"  readonly>
            </div>
            <div class="form-group">
              <label>Longitude</label>
              <input type="text" class="form-control" id="longitudeEdit" readonly>
            </div>
          </div>
          <div class="modal-footer">
            <input type="button" class="btn btn-default" data-dismiss="modal" id="cancelBtn" value="Cancel">
            <input type="submit" class="btn btn-success" value="Edit" id="editBtn">
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->




  <script src="https://unpkg.com/leaflet.markercluster@0.5.0/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <script>
    //MAP INIT
    var map = L.map('map').setView([-8.432670, 115.38573], 13);

    //TILELAYER INIT
    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>', 
    maxZoom: 18, 
    id: 'mapbox/streets-v11', 
    tileSize: 512, 
    zoomOffset: -1, 
    accessToken: 'pk.eyJ1IjoiYWJkaXB1cm5hd2FuIiwiYSI6ImNrbGJ6bHBxMDBrOWQydnAwZnFtZGIxZjMifQ.Dskf87XP5VuPW2Srnrz8tw'}).addTo(map);

    //MARKER ICON INIT
    var myIcon = L.icon({
      iconUrl: 'iconMarker.png',
      iconSize:     [32, 32], 
      iconAnchor:   [16, 32], 
      popupAnchor:  [0, -16] 
    });


    //let INIT
    let markerdata;
    let long;
    let lat;


  //EDIT MARKER FUNCTION
    function editMarker(id, nama, latitude, longitude, jenis){
      $('#editmodal').modal('show');
      document.getElementById('longitudeEdit').value=longitude;
      document.getElementById('latitudeEdit').value=latitude;
      document.getElementById('namaEdit').value=nama;
      document.getElementById('jenisEdit').value=jenis;

      $("#editBtn").on("click", function() {
        markerData = {"lat": $('#latitudeEdit').val(),"lng":$('#longitudeEdit').val(),"zoom":map.getZoom(),"nama": $('#namaEdit').val(), "jenis": $('#jenisEdit').val(), "id": id}
        $.ajax({
          url: "./markerController/EditMarker.php",
          type: "post",
          data: markerData,
          success: function (response){
            var marker = map.getMarkerById(id);
            marker.closePopup();
            $('#editmodal').modal('hide');
            alertSuccess("Sekolah Berhasil Diedit");
            var object = jQuery.parseJSON(response);
            var btn_edit = '<button onclick="editMarker('+"'"+id+"','"+object.nama_sekolah+"','"+object.latitude+"','"+object.longitude+"','"+object. jenis+"',"+')" class="btn btn-warning btn-sm" style="margin-right: 5px;">edit</button>';
            var btn_delete = '<button onclick="deleteMarker('+"'"+id+"'"+')" class="btn btn-danger btn-sm">delete</button>';
            var pop_up = "<h4> Detail Sekolah </h1>" + '<br>' + 'Nama Sekolah: ' + object.nama_sekolah + '<br>' + 'Jenis Sekolah: ' + object.jenis + '<br>' + 'Latitude: ' + object.latitude + '<br>' + 'Longitude: ' + object.longitude + '<br><br>' + btn_edit + btn_delete;
            
            marker.bindPopup(pop_up);
             

            if(object.jenis == "SD"){
              SDmarkers.addLayer(marker);
            }else if(object.jenis == "SMP"){
              SMPmarkers.addLayer(marker);
            }else if(object.jenis == "SMA"){
              SMAmarkers.addLayer(marker);
            }

            marker.on('click',function(e){
              marker.openPopup();
            }); 
          }
        });
      });
    }

    function deleteMarker(id){
      swal({
          title: 'Anda yakin ingin menghapus data?',
          text: 'Data yang dihapus tidak akan bisa dikembalikan lagi!',
          icon: 'warning',
          buttons: ["Tidak", "Ya"],
      }).then(function(value) {
          if (value) {
              destroyMarker(id);
          }
      });
    }

    function destroyMarker(id){
      var url = 'markerController/deleteMarker.php';
      $.ajax({
          url : url,
          method: 'POST',
          data : {
              id: id
          },
          success: function(response){
              var marker = map.getMarkerById(id);
              map.removeLayer(marker);
              alertSuccess(response);
          }
      })
    }


    function alertSuccess(msg){
      swal({
          title: "Sukses",
          text: msg,
          icon: "success",
          button: "Ok",
      });
    }

    function alertCluster(msg){
      swal({
          title: "Cluster Info",
          text: msg,
          icon: "info",
          button: "Ok",
      });
    }

  //MAP ONCLICK LISTENER
    map.on('click', function(e) {
      $('#mymodal').modal('show');
              long = document.getElementById('longitude').value=e.latlng.lng;
              lat = document.getElementById('latitude').value=e.latlng.lat;
              document.getElementById('nama').value="";
    });

    //ADD MARKER
    $("#addBtn").on("click", function() {
      markerData = {"lat": $('#latitude').val(),"lng":$('#longitude').val(),"zoom":map.getZoom(),"nama": $('#nama').val(), "jenis": $('#jenis').val()}
      $.ajax({
        url: "markerController/addMarker.php",
        type: "post",
        data: markerData,
        success: function (response){
          $('#mymodal').modal('hide');
          var object = jQuery.parseJSON(response);
          var btn_edit = '<button onclick="editMarker('+"'"+object.id_marker+"','"+object.nama_sekolah+"','"+object.latitude+"','"+object.longitude+"','"+object.jenis+"',"+')" class="btn btn-warning btn-sm" style="margin-right: 5px;">edit</button>';
          var btn_delete = '<button onclick="deleteMarker('+"'"+object.id_marker+"'"+')" class="btn btn-danger btn-sm">delete</button>';
          var pop_up = "<h4> Detail Sekolah </h1>" + '<br>' + 'Nama Sekolah: ' + object.nama_sekolah + '<br>' + 'Jenis Sekolah: ' + object.jenis + '<br>' + 'Latitude: ' + object.latitude + '<br>' + 'Longitude: ' + object.longitude + '<br><br>' + btn_edit + btn_delete;
          var marker = L.marker([object.latitude, object.longitude],{
            id: object.id_marker,
            icon: myIcon 
          }).bindPopup(pop_up); 

          if(object.jenis == "SD"){
            SDmarkers.addLayer(marker);
          }else if(object.jenis == "SMP"){
            SMPmarkers.addLayer(marker);
          }else if(object.jenis == "SMA"){
            SMAmarkers.addLayer(marker);
          }
          
          marker.on('click',function(e){
            marker.openPopup();
          });
          
          alertSuccess("Marker Berhasil Ditambahkan");
        }
      });
    });

    //MARKER CLUSTER INIT
    var SDmarkers = L.markerClusterGroup({
      maxClusterRadius: 30,
      iconCreateFunction: function(cluster){
        return L.divIcon({
          iconSize: [30,30],
          iconAnchor: [15,30],
          html: '<div class="leaflet-div-icon-SD">' + cluster.getChildCount() + '</div>'  
        })
      }
    });
    map.addLayer(SDmarkers);

    SDmarkers.on('clusterclick', function(e) {
      var count = e.layer.getAllChildMarkers().length
      alertCluster("Jumlah SD dalam Cluster Ini: " + count);
    });


    var SMPmarkers = L.markerClusterGroup({
      maxClusterRadius: 30,
      iconCreateFunction: function(cluster){
        return L.divIcon({
          iconSize: [30,30],
          iconAnchor: [15,30],
          html: '<div class="leaflet-div-icon-SMP">' + cluster.getChildCount() + '</div>'  
        })
      }
    });
    map.addLayer(SMPmarkers);

    SMPmarkers.on('clusterclick', function(e) {
      var count = e.layer.getAllChildMarkers().length
      alertCluster("Jumlah SMP dalam Cluster Ini: " + count);
    });

    var SMAmarkers = L.markerClusterGroup({
      maxClusterRadius: 30,
      iconCreateFunction: function(cluster){
        return L.divIcon({
          iconSize: [30,30],
          iconAnchor: [15,30],
          html: '<div class="leaflet-div-icon-SMA">' + cluster.getChildCount() + '</div>'  
        })
      }
    });
    map.addLayer(SMAmarkers);

    SMAmarkers.on('clusterclick', function(e) {
      var count = e.layer.getAllChildMarkers().length
      alertCluster("Jumlah SMA dalam Cluster Ini: " + count);
    });

    //READ MARKER FROM SERVER
    $.getJSON('markerController/loadMarker.php', {get_param: 'value'}, function(data) {
      $.each(data, function(index, element) {   
        var btn_edit = '<button onclick="editMarker('+"'"+element.id_marker+"','"+element.nama_sekolah+"','"+element.latitude+"','"+element.longitude+"','"+element.jenis+"',"+')" class="btn btn-warning btn-sm" style="margin-right: 5px;">edit</button>';
        var btn_delete = '<button onclick="deleteMarker('+"'"+element.id_marker+"'"+')" class="btn btn-danger btn-sm">delete</button>';
        var pop_up = "<h4> Detail Sekolah </h1>" + '<br>' + 'Nama Sekolah: ' + element.nama_sekolah + '<br>' + 'Jenis Sekolah: ' + element.jenis + '<br>' + 'Latitude: ' + element.latitude + '<br>' + 'Longitude: ' + element.longitude + '<br><br>' + btn_edit + btn_delete;
        var marker = L.marker([element.latitude, element.longitude],{
          id: element.id_marker,
          icon: myIcon 
        }).bindPopup(pop_up);

        if(element.jenis == "SD"){
          SDmarkers.addLayer(marker);
        }else if(element.jenis == "SMP"){
          SMPmarkers.addLayer(marker);
        }else if(element.jenis == "SMA"){
          SMAmarkers.addLayer(marker);
        }
        
        marker.on('click',function(e){
          marker.openPopup();
          });
        });
    });

    L.Map.include({
            getMarkerById: function (id) {
                var marker = null;
                this.eachLayer(function (layer) {
                    if (layer instanceof L.Marker) {
                        if (layer.options.id === id) {
                            marker = layer;
                        }
                    }
                });
                return marker;
            }
        });
  </script>
  </body>
</html>